name: Windows CUDA Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows-cuda:
    runs-on: windows-2022
    defaults:
      run:
        # Use PowerShell for reliable path handling on Windows
        shell: powershell

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # If submodules are needed (like for external libs), uncomment the line below
          # submodule: 'true'

      # =================================================================
      # Step 1: Check CUDA Environment (Optional, for debugging)
      # =================================================================
      - name: Check available CUDA paths (Optional)
        run: |
          # List the contents of the main CUDA installation directory to verify available versions.
          Get-ChildItem -Path "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\" | Select-Object Name, FullName

      # =================================================================
      # Step 2: Configure with CMake
      # Translates:
      # 1. mkdir build
      # 2. cmake .. -G "Visual Studio 17 2022" -A x64 -DCUDA_TOOLKIT_ROOT_DIR="..."
      # Note: We use -B build to create the directory and configure in one go.
      # =================================================================
      - name: Configure CMake for Visual Studio 2022 (Release)
        run: |
          # The -B build command creates the build directory automatically.
          # We use the specific CUDA path requested, assuming it is available or configured.
          cmake -S . -B build `
          -G "Visual Studio 17 2022" -A x64 `
          -DCUDA_TOOLKIT_ROOT_DIR="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.9" `
          -DWITH_HWLOC=ON -DWITH_ADL=OFF -DWITH_CUDA=ON -DWITH_TLS=ON -DWITH_HTTP=ON

      # =================================================================
      # Step 3: Build the Project
      # Translates:
      # 1. cmake --build . --config Release
      # =================================================================
      - name: Build the Release Configuration
        run: |
          # Building the project configured in the 'build' directory.
          cmake --build build --config Release --parallel

      # =================================================================
      # Step 4: Upload Artifacts
      # The resulting executable will be in build/Release/xmrig.exe
      # =================================================================
      - name: Upload Windows Executable
        uses: actions/upload-artifact@v4
        with:
          name: xmrig-windows-cuda
          path: build/Release/xmrig.exe
          retention-days: 7

      - name: List Artifact Contents (Optional)
        run: |
          Get-ChildItem -Path "build/Release"
